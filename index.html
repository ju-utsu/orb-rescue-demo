<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>Orb Rescue — Continuous Orbs + Ambient</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#000;font-family:Arial,Helvetica,sans-serif}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;
      background:linear-gradient(rgba(0,0,0,0.6),rgba(0,0,0,0.35));color:#fff;text-align:center;padding:20px;}
    .btn{appearance:none;border:0;background:#1abc9c;color:#042;padding:12px 18px;font-size:16px;border-radius:10px;cursor:pointer}
    .hud{position:fixed;left:12px;top:12px;z-index:999;color:#fff;background:rgba(0,0,0,0.22);padding:8px 12px;border-radius:8px;font-size:14px}
    .hint{position:fixed;right:10px;bottom:10px;z-index:999;color:#fff;font-size:12px}
  </style>
</head>
<body>

  <div id="startOverlay" class="overlay">
    <div>
      <h2 style="margin:0 0 8px 0">Orb Rescue — Tap to Start</h2>
      <p style="margin:0 0 12px 0">Tap <strong>Start Demo</strong> to unlock audio and begin the game. Then press the VR/Cardboard button for headset mode.</p>
      <button id="startBtn" class="btn">Start Demo</button>
      <p style="margin-top:8px;font-size:12px;color:#ddd">(Use Chrome on Android. If audio doesn't play, tap the screen once after pressing Start.)</p>
    </div>
  </div>

  <div id="hud" class="hud">Score: 0 &nbsp;•&nbsp; Time: 120s</div>
  <div class="hint">Look at an orb for 1s to collect it</div>

  <a-scene embedded vr-mode-ui="enterVRButton:true" background="color:#8fcff3">
    <!-- Simple pretty environment (low-cost) -->
    <a-sky color="#f7d9d5"></a-sky>
    <a-entity light="type: ambient; intensity:0.7"></a-entity>
    <a-entity light="type: directional; intensity:0.9" position="-1 3 1"></a-entity>
    <a-plane rotation="-90 0 0" width="80" height="80" color="#2b6b3f"></a-plane>

    <!-- Player camera and visible cursor -->
    <a-entity id="player" position="0 1.6 0">
      <a-entity camera look-controls>
        <a-entity id="cursor" geometry="primitive:ring; radiusInner:0.015; radiusOuter:0.03"
                  material="color:#fff; shader:flat; opacity:0.95"
                  position="0 0 -1"
                  cursor="fuse:false"
                  raycaster="objects:.collectible"></a-entity>
      </a-entity>
    </a-entity>

    <!-- Templates -->
    <a-entity id="orbTemplate" visible="false">
      <a-entity>
        <a-sphere radius="0.28" material="shader:standard; metalness:0.25; roughness:0.08" class="collectible"></a-sphere>
        <a-pointlight intensity="1.0" distance="6"></a-pointlight>
      </a-entity>
    </a-entity>

    <a-entity id="flashTemplate" visible="false">
      <a-ring radius-inner="0.05" radius-outer="0.18" material="color:#fff; shader:flat; opacity:0.95"
              animation="property: scale; to:1.8 1.8 1.8; dur:260; easing:easeOutQuad"></a-ring>
    </a-entity>

    <script>
      // ----- Game state -----
      const Game = {
        score: 0,
        timeLeft: 120,
        maxOrbs: 18,
        spawnInterval: 1400,
        audioUnlocked: false,
        audioCtx: null,
        ambientNodes: null,
        orbSpawner: null,
        timerInterval: null
      };

      // ----- Audio Manager (ambient pad + collect) -----
      const AudioMgr = (function(){
        let ctx = null;
        function ensureCtx(){
          if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
          return ctx;
        }
        async function unlock(){
          const c = ensureCtx();
          if (c.state === 'suspended' && c.resume) {
            try { await c.resume(); } catch(e) { /* ignore */ }
          }
          // create a tiny buffer to ensure unlocked on some phones
          if (c.createBuffer) {
            const buffer = c.createBuffer(1,1,c.sampleRate);
            const src = c.createBufferSource(); src.buffer = buffer; src.connect(c.destination);
            if (src.start) try { src.start(0); } catch(e) {}
          }
          Game.audioUnlocked = true;
        }

        function startAmbient(){
          const c = ensureCtx();
          // master gain
          const master = c.createGain(); master.gain.value = 0.0001; master.connect(c.destination);
          // lowpass to mellow
          const lp = c.createBiquadFilter(); lp.type = 'lowpass'; lp.frequency.value = 1000; lp.Q.value = 0.7;
          master.connect(lp); lp.connect(c.destination);
          // oscillators (soft chords)
          const freqs = [110, 220, 330];
          const oscs = freqs.map((f,i)=>{
            const o = c.createOscillator();
            const g = c.createGain();
            o.type = 'sine';
            o.frequency.value = f + (Math.random()*6 - 3);
            o.connect(g); g.connect(master);
            g.gain.value = 0.0001;
            o.start();
            g.gain.linearRampToValueAtTime(0.06/(i+1), c.currentTime + 1 + i*0.2);
            return {osc:o,gain:g};
          });
          // slow LFO to modulate master gain a bit
          const lfo = c.createOscillator(); lfo.frequency.value = 0.05;
          const lfoGain = c.createGain(); lfoGain.gain.value = 0.02;
          lfo.connect(lfoGain); lfoGain.connect(master.gain);
          lfo.start();

          // fade master in
          master.gain.linearRampToValueAtTime(0.7, c.currentTime + 2.2);

          Game.ambientNodes = {master,lp,oscs,lfo,lfoGain};
        }

        function playCollect(){
          const c = ensureCtx();
          const o = c.createOscillator();
          const g = c.createGain();
          o.type = 'triangle'; o.frequency.value = 900;
          o.connect(g); g.connect(c.destination);
          g.gain.setValueAtTime(0.0001, c.currentTime);
          g.gain.exponentialRampToValueAtTime(0.14, c.currentTime + 0.01);
          o.frequency.exponentialRampToValueAtTime(1200, c.currentTime + 0.12);
          g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + 0.24);
          o.start(); o.stop(c.currentTime + 0.26);
        }

        function stopAmbient(){
          const nodes = Game.ambientNodes; if (!nodes) return;
          const c = ensureCtx();
          try {
            nodes.master.gain.linearRampToValueAtTime(0.0001, c.currentTime + 0.6);
            nodes.oscs.forEach(o=> o.osc.stop(c.currentTime + 0.7));
            nodes.lfo.stop(c.currentTime + 0.7);
          } catch(e) {}
          Game.ambientNodes = null;
        }

        return {ensureCtx,unlock,startAmbient,playCollect,stopAmbient};
      })();

      // ----- Gaze collectible component -----
      AFRAME.registerComponent('gaze-collectible', {
        schema: {gazeTime: {type:'int', default:1000}},
        init: function(){
          this.timer = null; this.collected=false;
          this.enter = () => { if (this.collected) return; this.timer = setTimeout(()=>this.collect(), this.data.gazeTime); this.el.setAttribute('animation__hover','property:scale;to:1.12 1.12 1.12;dur:200;easing:easeOutQuad'); };
          this.leave = () => { if (this.timer){ clearTimeout(this.timer); this.timer=null; } this.el.removeAttribute('animation__hover'); this.el.setAttribute('scale','1 1 1'); };
          this.click = () => { if (!this.collected) this.collect(); };
          this.el.addEventListener('mouseenter', this.enter);
          this.el.addEventListener('mouseleave', this.leave);
          this.el.addEventListener('click', this.click);
        },
        collect: function(){
          if (this.collected) return; this.collected=true;
          const val = parseInt(this.el.getAttribute('data-value') || '1');
          Game.score += val; updateHUD();
          if (Game.audioUnlocked) AudioMgr.playCollect();
          spawnFlash(this.el.object3D.position);
          this.el.setAttribute('animation__pop','property:scale;to:2 2 2;dur:220;easing:easeOutQuad');
          setTimeout(()=>{ if (this.el.parentNode) this.el.parentNode.removeChild(this.el.parentNode); },260);
        },
        remove: function(){ this.el.removeEventListener('mouseenter', this.enter); this.el.removeEventListener('mouseleave', this.leave); this.el.removeEventListener('click', this.click); }
      });

      // HUD update
      function updateHUD(){ document.getElementById('hud').innerText = `Score: ${Game.score} • Time: ${Game.timeLeft}s`; }

      // spawn flash
      function spawnFlash(pos){
        const t = document.getElementById('flashTemplate').cloneNode(true);
        t.setAttribute('visible', true);
        t.object3D.position.copy(pos);
        document.querySelector('a-scene').appendChild(t);
        setTimeout(()=>{ if (t.parentNode) t.parentNode.removeChild(t); },420);
      }

      // spawn orb wrapper (template contains a-sphere + pointlight)
      function spawnOrb(){
        const current = document.querySelectorAll('.collectible').length;
        if (current >= Game.maxOrbs) return;
        const scene = document.querySelector('a-scene');
        const template = document.getElementById('orbTemplate').cloneNode(true);
        template.setAttribute('visible', true);
        // choose color/value
        const palette = [{c:'#ffd86b',v:1},{c:'#88f0ff',v:2},{c:'#ff88e0',v:3},{c:'#aaff8c',v:1}];
        const pick = palette[Math.floor(Math.random()*palette.length)];
        // position around player in radius 3-6, biased forward a bit
        const r = 3 + Math.random()*3;
        const angle = Math.random()*Math.PI*2;
        const x = Math.cos(angle)*r;
        const z = Math.sin(angle)*r - (Math.random()*1.5); // slight forward bias
        const y = 0.8 + Math.random()*1.8;
        // set sphere (child)
        const sphere = template.querySelector('a-sphere');
        sphere.setAttribute('material', `color:${pick.c}; emissive:${pick.c}; metalness:0.25; roughness:0.06`);
        sphere.setAttribute('class','collectible');
        sphere.setAttribute('data-value', pick.v);
        sphere.setAttribute('gaze-collectible','gazeTime:1000');
        // update pointlight
        const pl = template.querySelector('a-pointlight');
        pl.setAttribute('color', pick.c);
        pl.setAttribute('intensity', 0.9);
        pl.setAttribute('distance', 6);
        // position wrapper
        template.setAttribute('position', `${x} ${y} ${z}`);
        // float animation on wrapper
        template.setAttribute('animation', `property: position; dir: alternate; dur: ${1200+Math.floor(Math.random()*900)}; to: ${x} ${y+0.16} ${z}; loop: true`);
        scene.appendChild(template);
        // auto cleanup uncollected after 22s
        setTimeout(()=>{ if (template.parentNode) template.parentNode.removeChild(template); },22000);
      }

      // spawn initial cluster and start intervals
      function startGame(){
        // ensure audio unlocked
        AudioMgr.unlock().then(()=> {
          Game.audioUnlocked = true;
          AudioMgr.startAmbient();
        }).catch(()=> { Game.audioUnlocked = false; });

        // initial cluster in front so player definitely sees orbs
        for (let i=0;i<8;i++){ setTimeout(spawnOrb, i*160); }
        Game.orbSpawner = setInterval(spawnOrb, Game.spawnInterval);

        Game.timerInterval = setInterval(()=> {
          Game.timeLeft--; updateHUD();
          if (Game.timeLeft <= 0) finishGame();
        },1000);
      }

      function finishGame(){
        clearInterval(Game.orbSpawner); clearInterval(Game.timerInterval);
        AudioMgr.stopAmbient();
        setTimeout(()=>{ alert('Time up! Final score: ' + Game.score); location.reload(); },700);
      }

      // Start button logic: resume audio context & start game
      document.getElementById('startBtn').addEventListener('click', async function(){
        try {
          await (AudioMgr.ensureCtx && AudioMgr.ensureCtx());
        } catch(e) {}
        // resume audio context for mobile
        try { if (AudioMgr.ensureCtx) { const c = AudioMgr.ensureCtx(); if (c.state === 'suspended') await c.resume(); } } catch(e) {}
        document.getElementById('startOverlay').style.display = 'none';
        // short extra tap hint to help unlocking on some phones
        setTimeout(()=> startGame(), 120);
      });

      // Desktop debug: space collects first orb
      window.addEventListener('keydown', e=> { if (e.key === ' ') { const o = document.querySelector('.collectible'); if (o) o.emit('click'); } });

      // ensure HUD initially correct
      updateHUD();
    </script>

  </a-scene>
</body>
</html>

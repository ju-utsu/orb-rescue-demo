<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Sphere - WebXR Gaze Training</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }
        
        canvas {
            display: block;
            touch-action: none;
        }
        
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 100;
            color: white;
            text-align: center;
            pointer-events: none;
        }
        
        #score {
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 10px;
        }
        
        #level {
            font-size: 16px;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 20px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            pointer-events: all;
            z-index: 101;
        }
        
        #startButton:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            text-align: center;
            color: white;
            font-size: 14px;
            opacity: 0.8;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .gaze-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 200;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div id="ui">
        <div id="score">Score: 0</div>
        <div id="level">Level 1</div>
    </div>
    
    <button id="startButton">Start Focus Training</button>
    
    <div id="instructions">
        Look at the glowing spheres to collect them. Train your focus and reflexes!<br>
        Works in VR headsets or mobile browser.
    </div>
    
    <div class="gaze-cursor" id="gazeCursor"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Game state
        let scene, camera, renderer, raycaster;
        let spheres = [];
        let particles = [];
        let score = 0;
        let level = 1;
        let gameStarted = false;
        let xrSession = null;
        let gazeCursor;
        
        // Game settings
        const SPHERE_COUNT = 5;
        const GAZE_TIME = 1000; // ms to collect
        const LEVEL_THRESHOLD = 10;
        
        // Initialize the game
        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x667eea, 10, 50);
            
            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 0);
            
            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);
            
            // Enable XR
            renderer.xr.enabled = true;
            
            // Raycaster for gaze detection
            raycaster = new THREE.Raycaster();
            
            // Gaze cursor
            gazeCursor = document.getElementById('gazeCursor');
            
            // Create environment
            createEnvironment();
            
            // Event listeners
            document.getElementById('startButton').addEventListener('click', startGame);
            window.addEventListener('resize', onWindowResize);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('touchmove', onTouchMove);
            
            // Start render loop
            renderer.setAnimationLoop(animate);
        }
        
        function createEnvironment() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
            scene.add(ambientLight);
            
            // Point lights
            const colors = [0xff6b6b, 0x4ecdc4, 0x45b7d1, 0xf9ca24, 0x6c5ce7];
            for (let i = 0; i < 5; i++) {
                const light = new THREE.PointLight(colors[i], 0.8, 20);
                light.position.set(
                    Math.cos(i * Math.PI * 2 / 5) * 8,
                    2 + Math.sin(i * 0.5) * 2,
                    Math.sin(i * Math.PI * 2 / 5) * 8
                );
                scene.add(light);
            }
            
            // Starfield background
            createStarfield();
            
            // Floating platform
            const platformGeometry = new THREE.CylinderGeometry(8, 8, 0.2, 32);
            const platformMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x2c3e50,
                transparent: true,
                opacity: 0.7
            });
            const platform = new THREE.Mesh(platformGeometry, platformMaterial);
            platform.position.y = -2;
            scene.add(platform);
        }
        
        function createStarfield() {
            const starsGeometry = new THREE.BufferGeometry();
            const starsMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 2,
                transparent: true,
                opacity: 0.8
            });
            
            const starsVertices = [];
            for (let i = 0; i < 1000; i++) {
                const x = (Math.random() - 0.5) * 200;
                const y = (Math.random() - 0.5) * 200;
                const z = (Math.random() - 0.5) * 200;
                starsVertices.push(x, y, z);
            }
            
            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
            const starField = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(starField);
        }
        
        function createSphere(x, y, z) {
            const geometry = new THREE.SphereGeometry(0.3, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: new THREE.Color().setHSL(Math.random(), 0.8, 0.6),
                shininess: 100,
                transparent: true,
                opacity: 0.9
            });
            
            const sphere = new THREE.Mesh(geometry, material);
            sphere.position.set(x, y, z);
            sphere.userData = {
                gazeTime: 0,
                collected: false,
                originalScale: 1,
                pulsePhase: Math.random() * Math.PI * 2
            };
            
            // Add glow effect
            const glowGeometry = new THREE.SphereGeometry(0.35, 16, 16);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: material.color.clone().multiplyScalar(0.5),
                transparent: true,
                opacity: 0.3
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            sphere.add(glow);
            
            scene.add(sphere);
            spheres.push(sphere);
        }
        
        function spawnSpheres() {
            // Clear existing spheres
            spheres.forEach(sphere => scene.remove(sphere));
            spheres = [];
            
            // Create new spheres
            const count = Math.min(SPHERE_COUNT + Math.floor(level / 3), 12);
            for (let i = 0; i < count; i++) {
                const angle = (i / count) * Math.PI * 2;
                const radius = 3 + Math.random() * 4;
                const height = 0.5 + Math.random() * 2;
                
                const x = Math.cos(angle) * radius;
                const y = height;
                const z = Math.sin(angle) * radius;
                
                createSphere(x, y, z);
            }
        }
        
        function startGame() {
            gameStarted = true;
            document.getElementById('startButton').style.display = 'none';
            spawnSpheres();
            
            // Check for WebXR support
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
                    if (supported) {
                        // Add VR button
                        const vrButton = document.createElement('button');
                        vrButton.textContent = 'Enter VR';
                        vrButton.style.position = 'absolute';
                        vrButton.style.top = '20px';
                        vrButton.style.right = '20px';
                        vrButton.style.background = 'rgba(0,0,0,0.8)';
                        vrButton.style.color = 'white';
                        vrButton.style.border = 'none';
                        vrButton.style.padding = '10px 20px';
                        vrButton.style.borderRadius = '5px';
                        vrButton.style.cursor = 'pointer';
                        vrButton.addEventListener('click', () => {
                            navigator.xr.requestSession('immersive-vr').then((session) => {
                                renderer.xr.setSession(session);
                                xrSession = session;
                            });
                        });
                        document.body.appendChild(vrButton);
                    }
                });
            }
        }
        
        function updateGaze() {
            if (!gameStarted) return;
            
            // Get center of screen for gaze ray
            const centerX = 0;
            const centerY = 0;
            
            // Cast ray from camera center
            raycaster.setFromCamera({ x: centerX, y: centerY }, camera);
            const intersects = raycaster.intersectObjects(spheres);
            
            if (intersects.length > 0) {
                const sphere = intersects[0].object;
                if (!sphere.userData.collected) {
                    sphere.userData.gazeTime += 16; // ~60fps
                    
                    // Visual feedback
                    const progress = sphere.userData.gazeTime / GAZE_TIME;
                    sphere.scale.setScalar(1 + progress * 0.3);
                    sphere.material.opacity = 0.9 + progress * 0.1;
                    
                    // Collect sphere
                    if (sphere.userData.gazeTime >= GAZE_TIME) {
                        collectSphere(sphere);
                    }
                }
            } else {
                // Reset gaze time for all spheres
                spheres.forEach(sphere => {
                    if (!sphere.userData.collected) {
                        sphere.userData.gazeTime = Math.max(0, sphere.userData.gazeTime - 32);
                        const progress = sphere.userData.gazeTime / GAZE_TIME;
                        sphere.scale.setScalar(1 + progress * 0.3);
                        sphere.material.opacity = 0.9 + progress * 0.1;
                    }
                });
            }
        }
        
        function collectSphere(sphere) {
            sphere.userData.collected = true;
            score++;
            
            // Create particle explosion
            createParticleExplosion(sphere.position);
            
            // Remove sphere with animation
            const tween = {
                scale: 1,
                opacity: 0.9
            };
            
            const animate = () => {
                tween.scale += 0.1;
                tween.opacity -= 0.05;
                sphere.scale.setScalar(tween.scale);
                sphere.material.opacity = tween.opacity;
                
                if (tween.opacity > 0) {
                    requestAnimationFrame(animate);
                } else {
                    scene.remove(sphere);
                    spheres = spheres.filter(s => s !== sphere);
                }
            };
            animate();
            
            // Update UI
            document.getElementById('score').textContent = `Score: ${score}`;
            
            // Check for level up
            if (score > 0 && score % LEVEL_THRESHOLD === 0) {
                level++;
                document.getElementById('level').textContent = `Level ${level}`;
                setTimeout(() => spawnSpheres(), 1000);
            }
            
            // Spawn new spheres if all collected
            if (spheres.filter(s => !s.userData.collected).length === 0) {
                setTimeout(() => spawnSpheres(), 500);
            }
        }
        
        function createParticleExplosion(position) {
            const particleCount = 20;
            for (let i = 0; i < particleCount; i++) {
                const particle = new THREE.Mesh(
                    new THREE.SphereGeometry(0.02, 8, 8),
                    new THREE.MeshBasicMaterial({
                        color: new THREE.Color().setHSL(Math.random(), 0.8, 0.6)
                    })
                );
                
                particle.position.copy(position);
                particle.userData = {
                    velocity: new THREE.Vector3(
                        (Math.random() - 0.5) * 0.2,
                        Math.random() * 0.2,
                        (Math.random() - 0.5) * 0.2
                    ),
                    life: 1.0
                };
                
                scene.add(particle);
                particles.push(particle);
            }
        }
        
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.position.add(particle.userData.velocity);
                particle.userData.velocity.y -= 0.01; // gravity
                particle.userData.life -= 0.02;
                particle.material.opacity = particle.userData.life;
                
                if (particle.userData.life <= 0) {
                    scene.remove(particle);
                    particles.splice(i, 1);
                }
            }
        }
        
        function onMouseMove(event) {
            // Update gaze cursor position
            gazeCursor.style.left = event.clientX + 'px';
            gazeCursor.style.top = event.clientY + 'px';
        }
        
        function onTouchMove(event) {
            if (event.touches.length > 0) {
                gazeCursor.style.left = event.touches[0].clientX + 'px';
                gazeCursor.style.top = event.touches[0].clientY + 'px';
            }
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate(time) {
            // Update sphere animations
            spheres.forEach((sphere, index) => {
                if (!sphere.userData.collected) {
                    sphere.userData.pulsePhase += 0.05;
                    const pulse = Math.sin(sphere.userData.pulsePhase) * 0.1 + 1;
                    sphere.children[0].scale.setScalar(pulse); // glow effect
                    
                    // Gentle floating motion
                    sphere.position.y += Math.sin(time * 0.001 + index) * 0.002;
                    sphere.rotation.y += 0.01;
                }
            });
            
            updateGaze();
            updateParticles();
            
            renderer.render(scene, camera);
        }
        
        // Start the game
        init();
    </script>
</body>
</html>

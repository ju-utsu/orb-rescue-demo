<!DOCTYPE html><html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Tomato VR â€” Orb Collector (Gear GLTF)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#06101a;color:#fff;font-family:system-ui}
    #hud{position:fixed;left:12px;top:12px;z-index:9999;font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,.6);font-size:13px;background:rgba(0,0,0,0.45);padding:8px 10px;border-radius:8px}
    #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:8px 12px;border-radius:10px;display:none;z-index:9998;font-size:13px}
    #menuOverlay{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:10000;background:rgba(10,10,14,0.95);padding:18px;border-radius:12px;color:#fff;width:320px;box-shadow:0 10px 30px rgba(0,0,0,.6)}
    #menuOverlay h3{margin:0 0 8px 0}
    #menuOverlay label{font-size:13px}
    #menuOverlay input{width:100%;padding:8px;margin-top:6px;margin-bottom:10px;border-radius:6px;border:1px solid #333;background:#0f1520;color:#fff}
    #menuOverlay .row{display:flex;gap:8px}
    #menuOverlay button{padding:10px;border-radius:8px;border:none;background:#1f9cff;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div id="hud">Score: <span id="scoreVal">0</span> &nbsp;|&nbsp; Time: <span id="timeVal">60</span>s</div>
  <div id="toast"></div>  <!-- HTML settings overlay -->  <div id="menuOverlay" role="dialog" aria-hidden="true">
    <h3>Game Settings</h3>
    <label>Orb gaze time (ms)</label>
    <input id="orbGazeInput" type="number" min="50" step="50" value="150">
    <label>Danger gaze time (ms)</label>
    <input id="dangerGazeInput" type="number" min="50" step="50" value="500">
    <div class="row">
      <button id="saveSettings">Save & Close</button>
      <button id="restartBtn">Restart</button>
    </div>
  </div>  <a-scene renderer="antialias:true" background="color:#06101a">
    <a-assets>
      <audio id="collectSound" src="https://cdn.aframe.io/basic-guide/audio/click.ogg"></audio>
      <audio id="dangerSound" src="https://cdn.aframe.io/basic-guide/audio/explosion.ogg"></audio>
      <!-- GLTF gear model asset (public CDN) -->
      <a-asset-item id="gearModel" src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/GearboxAssy/glTF-Binary/GearboxAssy.glb"></a-asset-item>
    </a-assets><!-- Environment -->
<a-entity light="type:ambient;intensity:0.7"></a-entity>
<a-entity light="type:directional;intensity:0.8" position="1 3 -2"></a-entity>
<a-sky color="#061733"></a-sky>
<a-plane rotation="-90 0 0" width="120" height="120" color="#07121a"></a-plane>

<!-- Camera rig -->
<a-entity id="rig" position="0 1.6 0">
  <a-entity id="camera" camera look-controls>
    <!-- Reticle ring (visible) -->
    <a-ring id="reticle" position="0 0 -0.95" radius-inner="0.01" radius-outer="0.02" color="#fff"></a-ring>
    <!-- Raycaster used for intersection detection -->
    <a-entity id="ray" raycaster="objects: .interactable; interval:50" position="0 0 0"></a-entity>
  </a-entity>
</a-entity>

<!-- Gear (world-space GLTF) -->
<a-entity id="gear" class="interactable ui"
          gltf-model="#gearModel"
          position="0 1.4 -1.2" scale="0.05 0.05 0.05" rotation="0 0 0" visible="false"
          animation__spin="property: rotation; to: 0 360 0; dur: 12000; easing: linear; loop: true">
</a-entity>

<!-- Spawners -->
<a-entity id="collect-spawner"></a-entity>
<a-entity id="danger-spawner"></a-entity>

<!-- Game over panel (3D) -->
<a-entity id="gameOverPanel" visible="false">
  <a-entity position="0 1.4 -1.2">
    <a-plane width="1.0" height="0.5" color="#200" material="opacity:0.95"></a-plane>
    <a-text id="gameOverText" value="GAME OVER" color="#fff" position="-0.4 0.12 0.01"></a-text>
  </a-entity>
</a-entity>

  </a-scene>  <script>
    // State
    const state = {
      running: true,
      paused: false,
      score: 0,
      orbGazeMs: 150, // default
      dangerGazeMs: 500,
      timers: new Map(),
      TOTAL_ORBS: 20,
      TOTAL_DANGER: 10,
      spawnedOrbs: 0,
      spawnedDanger: 0,
      orbInterval: null,
      dangerInterval: null,
      roundTime: 60,
      roundTimer: null
    };

    // DOM refs
    const scoreVal = document.getElementById('scoreVal');
    const timeVal = document.getElementById('timeVal');
    const toast = document.getElementById('toast');
    const overlay = document.getElementById('menuOverlay');
    const orbInput = document.getElementById('orbGazeInput');
    const dangerInput = document.getElementById('dangerGazeInput');
    const saveBtn = document.getElementById('saveSettings');
    const restartBtnHtml = document.getElementById('restartBtn');

    function showToast(msg, ms=1200){ toast.textContent = msg; toast.style.display='block'; clearTimeout(toast._t); toast._t = setTimeout(()=> toast.style.display='none', ms); }
    function setScore(v){ state.score = v; scoreVal.textContent = v; }

    // Spawning (staggered)
    const collectSpawner = document.getElementById('collect-spawner');
    const dangerSpawner = document.getElementById('danger-spawner');

    function randPos(){ const x = (Math.random()*10)-5; const y = 0.9 + Math.random()*1.6; const z = - (2 + Math.random()*8); return {x,y,z}; }

    function spawnOrb(){ const p = randPos(); const orb = document.createElement('a-sphere'); orb.classList.add('interactable','collectable'); orb.setAttribute('radius','0.28'); orb.setAttribute('color','#ffd84d'); orb.setAttribute('emissive','#ffeb99'); orb.setAttribute('position', `${p.x} ${p.y} ${p.z}`); orb.setAttribute('animation__float', `property: position; dir: alternate; dur: ${2000+Math.floor(Math.random()*1200)}; to: ${p.x} ${p.y+0.25} ${p.z}; loop:true; easing: easeInOutSine`); orb.dataset.gaze = 'collect'; collectSpawner.appendChild(orb); }
    function spawnDanger(){ const p = randPos(); const bad = document.createElement('a-box'); bad.classList.add('interactable','danger'); bad.setAttribute('width','0.45'); bad.setAttribute('height','0.45'); bad.setAttribute('depth','0.45'); bad.setAttribute('color','#d43b3b'); bad.setAttribute('position', `${p.x} ${Math.max(0.5,p.y-0.6)} ${p.z}`); bad.setAttribute('animation__rot','property: rotation; to: 0 360 0; dur: 6000; loop:true; easing:linear'); bad.dataset.gaze = 'danger'; dangerSpawner.appendChild(bad); }

    function startStaggeredSpawns(){
      if(state.orbInterval) clearInterval(state.orbInterval);
      if(state.dangerInterval) clearInterval(state.dangerInterval);
      state.spawnedOrbs = 0; state.spawnedDanger = 0;
      state.orbInterval = setInterval(()=>{
        if(state.spawnedOrbs < state.TOTAL_ORBS){ spawnOrb(); state.spawnedOrbs++; }
        else clearInterval(state.orbInterval);
      }, 150);
      state.dangerInterval = setInterval(()=>{
        if(state.spawnedDanger < state.TOTAL_DANGER){ spawnDanger(); state.spawnedDanger++; }
        else clearInterval(state.dangerInterval);
      }, 450);
    }

    // start spawns
    startStaggeredSpawns();

    // Reticle and ray handling
    const ray = document.getElementById('ray');
    const reticle = document.getElementById('reticle');
    const gear = document.getElementById('gear');
    let hovered = null;

    // Position gear in front-right of camera
    const scene = document.querySelector('a-scene');
    function positionGear(){
      const cam = document.getElementById('camera').object3D;
      if(!cam) return;
      const pos = new THREE.Vector3(); cam.getWorldPosition(pos);
      const dir = new THREE.Vector3(); cam.getWorldDirection(dir);
      const right = new THREE.Vector3(); right.crossVectors(dir, new THREE.Vector3(0,1,0)).normalize();
      dir.multiplyScalar(1.0); right.multiplyScalar(0.6);
      pos.add(dir).add(right); pos.y -= 0.2;
      gear.object3D.position.copy(pos);
      gear.setAttribute('visible','true');
    }

    scene.addEventListener('loaded', ()=>{ positionGear(); });
    scene.addEventListener('enter-vr', ()=>{ setTimeout(positionGear,120); });

    ray.addEventListener('raycaster-intersection', (e)=>{
      const els = e.detail.els || (e.detail.intersections && e.detail.intersections.map(i=>i.object.el));
      const el = els && els.length ? els[0] : null;
      if(el && el !== hovered){ if(hovered) clearHover(hovered); startHover(el); hovered = el; }
    });
    ray.addEventListener('raycaster-intersection-cleared', ()=>{ if(hovered) clearHover(hovered); hovered = null; reticle.setAttribute('color','#ffffff'); reticle.setAttribute('scale','1 1 1'); });

    function startHover(el){ if(!el) return; const kind = el.dataset && el.dataset.gaze ? el.dataset.gaze : (el.id === 'gear' ? 'ui' : null); if(!kind) return;
      if(kind==='collect') reticle.setAttribute('color','#ffd84d');
      else if(kind==='danger') reticle.setAttribute('color','#ff4d4d');
      else reticle.setAttribute('color','#1f9cff');
      reticle.setAttribute('scale','1.6 1.6 1');
      if(kind==='ui'){ el.object3D.scale.set(0.06*1.2,0.06*1.2,0.06*1.2); el.setAttribute('animation__spin','property: rotation; to: 0 360 0; dur: 6000; easing: linear; loop: true'); }

      if(!state.running || state.paused) return;
      const ms = kind==='collect' ? state.orbGazeMs : (kind==='danger' ? state.dangerGazeMs : 200);
      const to = setTimeout(()=>{
        if(!state.running || state.paused) return;
        if(kind==='collect'){
          const pos = el.object3D.position; particleBurst(pos);
          document.getElementById('collectSound').play().catch(()=>{});
          el.parentNode && el.parentNode.removeChild(el);
          setScore(state.score+1);
        } else if(kind==='danger'){
          document.getElementById('dangerSound').play().catch(()=>{});
          triggerGameOver('Gazed at danger');
        } else if(kind==='ui'){
          openMenu();
        }
      }, ms);
      state.timers.set(el, to);
    }
    function clearHover(el){ const to = state.timers.get(el); if(to){ clearTimeout(to); state.timers.delete(el);} if(el && el.id==='gear'){ el.object3D.scale.set(0.05,0.05,0.05); el.setAttribute('animation__spin','property: rotation; to: 0 360 0; dur: 12000; easing: linear; loop: true'); } }

    // particle burst
    function particleBurst(pos){ for(let i=0;i<10;i++){ const p=document.createElement('a-sphere'); p.setAttribute('radius','0.04'); p.setAttribute('color','#fff'); p.object3D.position.set(pos.x,pos.y,pos.z); document.querySelector('a-scene').appendChild(p); const dx=pos.x+(Math.random()-0.5)*0.6; const dy=pos.y+Math.random()*0.8; const dz=pos.z+(Math.random()-0.5)*0.6; p.setAttribute('animation__m', `property: position; to: ${dx} ${dy} ${dz}; dur: 500; easing: easeOutQuad`); p.setAttribute('animation__f', `property: material.opacity; to:0; dur:500; delay:200`); setTimeout(()=>{ p.parentNode && p.parentNode.removeChild(p); },700); } }

    // Menu overlay functions
    function openMenu(){ state.paused = true; overlay.style.display = 'block'; overlay.setAttribute('aria-hidden','false'); orbInput.value = state.orbGazeMs; dangerInput.value = state.dangerGazeMs; showToast('Menu opened'); }
    function closeMenuSave(){ state.paused = false; overlay.style.display = 'none'; overlay.setAttribute('aria-hidden','true'); state.orbGazeMs = parseInt(orbInput.value) || state.orbGazeMs; state.dangerGazeMs = parseInt(dangerInput.value) || state.dangerGazeMs; showToast('Settings saved'); }
    function triggerGameOver(msg){ state.running = false; state.paused = true; const panel = document.getElementById('gameOverPanel'); document.getElementById('gameOverText').setAttribute('value', msg); panel.setAttribute('visible','true'); showToast('Game Over'); }

    // Bind overlay buttons
    saveBtn.addEventListener('click', ()=>{ closeMenuSave(); });
    restartBtnHtml.addEventListener('click', ()=>{ restart(); });

    // Restart logic
    function restart(){
      state.timers.forEach(t=>clearTimeout(t)); state.timers.clear();
      Array.from(collectSpawner.children).forEach(c=>c.remove()); Array.from(dangerSpawner.children).forEach(d=>d.remove());
      setScore(0); state.running = true; state.paused = false; document.getElementById('gameOverPanel').setAttribute('visible','false');
      startStaggeredSpawns(); showToast('Restarted');
    }

    // Round timer
    function startRound(){ clearInterval(state.roundTimer); state.roundTime = 60; timeVal.textContent = state.roundTime; state.roundTimer = setInterval(()=>{ if(!state.running || state.paused) return; state.roundTime -= 1; timeVal.textContent = state.roundTime; if(state.roundTime<=0){ clearInterval(state.roundTimer); triggerGameOver("Time's up"); } }, 1000); }

    // Start
    setScore(0); startRound();

    // Reposition gear periodically in case camera moves (comfort)
    setInterval(()=>{ if(!scene.is('loaded')) return; positionGear(); }, 3000);

  </script></body>
</html>
